<!DOCTYPE html>
<html dir="ltr">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- Tell the browser to be responsive to screen width -->
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="keywords"
      content="wrappixel, admin dashboard, html css dashboard, web dashboard, bootstrap 5 admin, bootstrap 5, css3 dashboard, bootstrap 5 dashboard, Matrix lite admin bootstrap 5 dashboard, frontend, responsive bootstrap 5 admin template, Matrix admin lite design, Matrix admin lite dashboard bootstrap 5 dashboard template"
    />
    <meta
      name="description"
      content="Matrix Admin Lite Free Version is powerful and clean admin dashboard template, inpired from Bootstrap Framework"
    />
    <meta name="robots" content="noindex,nofollow" />
    <title>POS Portal Login Page</title>
    <!-- Favicon icon -->
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="../assets/images/favicon.png"
    />
    <!-- Custom CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css"
    />
    <link href="../dist/css/style.min.css" rel="stylesheet" />
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style>
      #togglePassword {
        /* margin-left: -50px; */
        cursor: pointer;
        color: black;
        font-size: 20px;
      }

      .loader {
        display: none;
        position: fixed;
        top: 40%;
        left: 50%;
        border: 16px solid #f3f3f3;
        border-radius: 50%;
        border-top: 16px solid #3498db;
        width: 120px;
        height: 120px;
        -webkit-animation: spin 2s linear; /* Safari */
        animation: spin 2s linear;
      }

      /* Safari */
      @-webkit-keyframes spin {
        0% {
          -webkit-transform: rotate(0deg);
        }
        100% {
          -webkit-transform: rotate(360deg);
        }
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
    <script type="text/javascript">
      function preventBack() {
        window.history.forward();
      }
      setTimeout("preventBack()", 0);
      window.onunload = function () {
        null;
      };
    </script>
  </head>

  <body style="height: 100vh; width: 100vw">
    <div
      class="main-wrapper bg-dark"
      style="
        margin: auto;
        padding: auto;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      "
    >
      <!-- ============================================================== -->
      <!-- Preloader - style you can find in spinners.css -->
      <!-- ============================================================== -->
      <div class="preloader">
        <div class="lds-ripple">
          <div class="lds-pos"></div>
          <div class="lds-pos"></div>
        </div>
      </div>
      <!-- ============================================================== -->
      <!-- Preloader - style you can find in spinners.css -->
      <!-- ============================================================== -->
      <!-- ============================================================== -->
      <!-- Login box.scss -->
      <!-- ============================================================== -->
      <div style="width: 20%; margin: auto">
        <!-- <div class="text-center pt-3 pb-3">
          <h1 style="color: white; letter-spacing: 3px">LOG IN PAGE</h1>
        </div> -->
        <div class="text-center pt-3 pb-3">
          <span class="db"
            ><img src="../assets/images/logo.png" alt="logo"
          /></span>
        </div>
        <div class="auth-box bg-dark border-top border-secondary">
          <div id="loginform">
            <!-- <div class="text-center pt-3 pb-3">
              <span class="db"
                ><img src="../assets/images/logo.png" alt="logo"
              /></span>
            </div> -->
            <div class="text-center pt-3 pb-3">
              <h1
                style="
                  color: darkgray;
                  letter-spacing: 3px;
                  font-family: 'Courier New', Courier, monospace;
                "
              >
                LOGIN
              </h1>
            </div>
            <!-- Form -->
            <form class="form-horizontal mt-3" id="loginForm">
              <div class="row pb-4">
                <div class="col-12">
                  <div class="input-group mb-3">
                    <div class="input-group-prepend">
                      <span
                        class="input-group-text bg-success text-white h-100"
                        id="basic-addon1"
                        ><i class="mdi mdi-account fs-4"></i
                      ></span>
                    </div>
                    <input
                      id="username"
                      type="text"
                      class="form-control form-control-lg"
                      placeholder="Username"
                      aria-label="Username"
                      aria-describedby="basic-addon1"
                      required=""
                    />
                  </div>
                  <div class="input-group mb-3">
                    <div class="input-group-prepend">
                      <span
                        class="input-group-text bg-warning text-white h-100"
                        id="basic-addon2"
                        ><i class="mdi mdi-lock fs-4"></i
                      ></span>
                    </div>
                    <input
                      id="password"
                      type="password"
                      class="form-control form-control-lg"
                      placeholder="Password"
                      aria-label="Password"
                      aria-describedby="basic-addon1"
                      required=""
                    />
                    <div class="input-group-prepend">
                      <span class="input-group-text" id="basic-addon1"
                        ><i class="bi bi-eye-slash" id="togglePassword"></i
                      ></span>
                    </div>
                  </div>
                </div>
              </div>
              <!-- <div class="row border-top border-secondary">
                <div class="col-12">
                  <div class="form-group">
                    <div class="pt-3">
                      <button
                        class="btn btn-info"
                        id="to-recover"
                        type="button"
                      >
                        <i class="mdi mdi-lock fs-4 me-1"></i> Forgot password?
                      </button>
                      <button
                        id="login"
                        class="btn btn-success float-end text-white"
                        type="button"
                      >
                        Login
                      </button>
                    </div>
                  </div>
                </div>
              </div> -->
              <div
                style="
                  display: flex;
                  align-items: center;
                  justify-content: center;
                "
              >
                <div style="width: 100%">
                  <!-- class="btn btn-lg btn-info" -->
                  <button
                    id="login"
                    style="width: 100%"
                    class="btn btn-success float-end text-white"
                    type="button"
                  >
                    Login
                  </button>
                </div>
              </div>
              <div
                style="
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  margin-top: 20px;
                "
              >
                <div style="width: 100%; margin-right: 10px">
                  <button
                    class="btn btn-info"
                    style="width: 100%"
                    id="to-recover"
                    type="button"
                  >
                    <i class="mdi mdi-lock fs-4 me-1"></i> Forgot password?
                  </button>
                </div>
                <div style="width: 100%">
                  <button
                    id="login"
                    style="width: 100%; background-color: darkorange"
                    class="btn float-end text-white"
                    type="button"
                    onclick="gotoSignupPage()"
                  >
                    Go to Signup
                  </button>
                </div>
              </div>
            </form>
          </div>
          <div id="recoverform">
            <div class="text-center pt-3 pb-3">
              <h1
                style="
                  color: darkgray;
                  letter-spacing: 3px;
                  font-family: 'Courier New', Courier, monospace;
                  font-size: 30px;
                "
              >
                ACCOUNT RECOVERY
              </h1>
            </div>
            <div class="text-center">
              <span class="text-white"
                >Enter your email address below and we will send you
                instructions on how to recover your account.</span
              >
            </div>
            <div class="row mt-3">
              <form id="recoveryForm" class="col-12">
                <div class="input-group mb-3">
                  <div class="input-group-prepend">
                    <span
                      class="input-group-text bg-danger text-white h-100"
                      id="basic-addon1"
                      ><i class="mdi mdi-email fs-4"></i
                    ></span>
                  </div>
                  <input
                    id="email"
                    type="email"
                    class="form-control form-control-lg"
                    placeholder="Email Address"
                    aria-label="Username"
                    aria-describedby="basic-addon1"
                    required
                  />
                </div>
                <div class="row mt-3 pt-3 border-top border-secondary">
                  <div class="col-12">
                    <a
                      class="btn btn-success text-white"
                      href="#"
                      id="to-login"
                      name="action"
                      >Back To Login</a
                    >
                    <button
                      id="recover"
                      class="btn btn-info float-end"
                      type="button"
                      name="action"
                    >
                      Recover
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
          <!-- -END- -->
        </div>
      </div>
      <!-- ============================================================== -->
      <!-- Login box.scss -->
      <!-- ============================================================== -->
      <!-- ============================================================== -->
      <!-- Page wrapper scss in scafholding.scss -->
      <!-- ============================================================== -->
      <!-- ============================================================== -->
      <!-- Page wrapper scss in scafholding.scss -->
      <!-- ============================================================== -->
      <!-- ============================================================== -->
      <!-- Right Sidebar -->
      <!-- ============================================================== -->
      <!-- ============================================================== -->
      <!-- Right Sidebar -->
      <!-- ============================================================== -->
    </div>
    <!-- ============================================================== -->
    <!-- All Required js -->
    <!-- ============================================================== -->

    <!-- section-success -->
    <div id="success" class="wrapper-success">
      <div class="card">
        <div class="icon"><i class="fas fa-check-circle"></i></div>
        <div class="subject">
          <h3>Success!</h3>
          <p id="popup-description">Log in successfully!</p>
        </div>
      </div>
    </div>
    <!-- section-error -->
    <div id="error" class="wrapper-error">
      <div class="card">
        <div class="icon"><i class="fas fa-exclamation-circle"></i></div>
        <div class="subject">
          <h3>Warning!</h3>
          <p id="popup-warning-desc">Please fill up the missing fields!</p>
        </div>
      </div>
    </div>
    <div class="loader" id="loadingCircle"></div>
    <script src="../assets/libs/jquery/dist/jquery.min.js"></script>
    <!-- Bootstrap tether Core JavaScript -->
    <script src="../assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <!-- ============================================================== -->
    <!-- This page plugin js -->
    <!-- ============================================================== -->
    <script type="text/javascript" src="../public/loggedinState.js"></script>
    <script>
      $(".preloader").fadeOut();
      // ==============================================================
      // Login and Recover Password
      // ==============================================================
      $("#recoverform").hide();
      $("#to-recover").on("click", function () {
        $("#loginform").slideUp();
        $("#recoverform").fadeIn();
      });

      $("#to-login").click(function () {
        $("#recoverform").hide();
        $("#loginform").slideDown();
      });

      const togglePassword = document.querySelector("#togglePassword");
      const password = document.querySelector("#password");

      togglePassword.addEventListener("click", function () {
        const type =
          password.getAttribute("type") === "password" ? "text" : "password";
        // alert("New type: " + type);
        password.setAttribute("type", type);

        this.classList.toggle("bi-eye");
      });

      const inputFields = document.querySelectorAll("input");

      Array.from(inputFields).forEach((input) => {
        input.addEventListener("keypress", (event) => {
          const hey = input.getAttribute("id");
          if (event.key === "Enter") {
            if (hey == "username" || hey == "password") {
              event.preventDefault();
              document.getElementById("login").click();
            } else {
              event.preventDefault();
              document.getElementById("recover").click();
            }
          }
        });
      });

      async function hashPassword(password) {
        try {
          const encoder = new TextEncoder();

          // Convert the password to a Uint8Array
          const data = encoder.encode(password);

          // Generate the hash using the SubtleCrypto API
          const hashBuffer = await crypto.subtle.digest("SHA-256", data);

          // Convert the hash buffer to a hexadecimal string
          const hashArray = Array.from(new Uint8Array(hashBuffer));
          const hashedPassword = hashArray
            .map((byte) => byte.toString(10).padStart(2, "0"))
            .join("");

          // Create the final formatted password string
          const formattedPassword = `$2a$10$${hashedPassword}`;

          // Return the formatted password
          return formattedPassword;
        } catch (error) {
          console.error("Error hashing password:", error);
          throw error;
        }
      }

      $("#login").click(function () {
        if ($("#loginForm")[0].checkValidity()) {
          fetch("/getUserCredentials")
            .then((response) => response.json())
            .then((data) => {
              var isLoggedIn = false;

              data.forEach((row) => {
                if ($("#username").val() == row.username) {
                  isLoggedIn = true;

                  // Get form data
                  var userLoggedInData = {
                    userID: row.id,
                    uname: row.username,
                    passw: row.password,
                    logState: true,
                  };

                  // Send form data to the server-side script
                  $.ajax({
                    url: "/saveUserLoggedInData",
                    type: "POST",
                    contentType: "application/json",
                    // dataType: "json", // Expect JSON response
                    data: JSON.stringify(userLoggedInData),
                    success: function () {
                      console.log("Log In Successfully!");
                      loadingCircle.style.display = "block";
                      // success.style.display = "block";
                      $(".main-wrapper").css("opacity", "0.7");
                      setTimeout(function () {
                        loadingCircle.style.display = "none";
                        success.style.display = "block";
                        // success.style.display = "none";
                        $(".main-wrapper").css("opacity", "0.5");
                        // loadingCircle.style.display = "block";
                        setTimeout(function () {
                          success.style.display = "none";
                          // loadingCircle.style.display = "none";
                          $(".main-wrapper").css("opacity", "1");
                          const form = document.getElementById("loginForm");
                          form.reset();
                          location.href = "/job-order-listing";
                        }, 2000);
                      }, 2000);
                    },
                    error: function (xhr, status, error) {
                      console.error("Error logging in!", error);
                    },
                  });
                }
              });

              if (!isLoggedIn) {
                $("#loginForm")[0].reportValidity();
                document.getElementById("popup-warning-desc").innerHTML =
                  "Wrong username and password!";
                error.style.display = "block";
                $(".main-wrapper").css("opacity", "0.85");
                setTimeout(function () {
                  const form = document.getElementById("loginForm");
                  form.reset();
                  document.getElementById("popup-warning-desc").innerHTML =
                    "Please fill up the missing fields!";
                  error.style.display = "none";
                  $(".main-wrapper").css("opacity", "1");
                }, 2000);
              }
            })
            .catch((error) => console.error(error));
        } else {
          $("#loginForm")[0].reportValidity();
          error.style.display = "block";
          $(".main-wrapper").css("opacity", "0.85");
          setTimeout(function () {
            error.style.display = "none";
            $(".main-wrapper").css("opacity", "1");
          }, 2000);
        }
      });

      $("#recover").click(function () {
        if ($("#recoveryForm")[0].checkValidity()) {
          document.getElementById("popup-description").innerHTML =
            "Check your email for the instructions!";
          success.style.display = "block";
          $("#main-wrapper").css("opacity", "0.95");
          setTimeout(function () {
            document.getElementById("popup-description").innerHTML =
              "Log in successfully!";
            success.style.display = "none";
            $("#main-wrapper").css("opacity", "1");
            const form = document.getElementById("recoveryForm");
            form.reset();
            location.href = "/";
          }, 2000);
        } else {
          $("#recoveryForm")[0].reportValidity();
          document.getElementById("popup-warning-desc").innerHTML =
            "Please fill up the field!";
          error.style.display = "block";
          $("#main-wrapper").css("opacity", "0.95");
          setTimeout(function () {
            document.getElementById("popup-warning-desc").innerHTML =
              "Please fill up the missing fields!";
            error.style.display = "none";
            $("#main-wrapper").css("opacity", "1");
          }, 2000);
        }
      });

      function gotoSignupPage() {
        location.href = "/signup";
      }

      fetch("/getEmployeeListing")
        .then((response) => response.json())
        .then((data) => {
          data.forEach((row) => {});
        })
        .catch((error) => console.error(error));
    </script>
  </body>
</html>
